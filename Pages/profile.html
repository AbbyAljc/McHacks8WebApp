<!--
=========================================================
* Argon Dashboard - v1.2.0
=========================================================
* Product Page: https://www.creative-tim.com/product/argon-dashboard


* Copyright  Creative Tim (http://www.creative-tim.com)
* Coded by www.creative-tim.com



=========================================================
* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Start your development with a Dashboard for Bootstrap 4.">
    <meta name="author" content="Creative Tim">
    <title>Pocket Prescription - User Profile</title>
    <link rel="icon" href="../assets/img/brand/favicon.png" type="image/png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
    <link rel="stylesheet" href="../assets/vendor/nucleo/css/nucleo.css" type="text/css">
    <link rel="stylesheet" href="../assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" type="text/css">
    <link rel="stylesheet" href="../assets/css/argon.css?v=1.2.0" type="text/css">
    <link rel="stylesheet" href="../assets/custom/css/styles.css" type="text/css">

    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-firestore.js"></script>
</head>

<body class="bg-default">
    <nav class="sidenav navbar navbar-vertical  fixed-left  navbar-expand-xs navbar-light bg-white" id="sidenav-main">
        <div class="scrollbar-inner">
            <div class="navbar-inner">
                <div class="collapse navbar-collapse" id="sidenav-collapse-main">
                    <ul class="navbar-nav">
                        <img src="../assets/img/icons/common/_Logo.png" style="padding:10%;">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="ni ni-tv-2 text-primary"></i>
                                <span class="nav-link-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="">
                                <i class="ni ni-planet text-orange"></i>
                                <span class="nav-link-text">Explore</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="profile.html">
                                <i class="ni ni-single-02 text-yellow"></i>
                                <span class="nav-link-text">Profile</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="">
                                <i class="ni ni-bullet-list-67 text-default"></i>
                                <span class="nav-link-text">Analytics</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="login.html">
                                <i class="ni ni-key-25 text-info"></i>
                                <span class="nav-link-text">Authenticate</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="register.html">
                                <i class="ni ni-circle-08 text-pink"></i>
                                <span class="nav-link-text">Register</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <div class="main-content" id="panel">
        <nav class="navbar navbar-top navbar-expand navbar-dark bg-default border-bottom">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <form class="navbar-search navbar-search-light form-inline mr-sm-3" id="navbar-search-main">
                        <div class="form-group mb-0">
                            <div class="input-group input-group-alternative input-group-merge">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                                <input class="form-control" placeholder="Search" type="text">
                            </div>
                        </div>
                        <button type="button" class="close" data-action="search-close" data-target="#navbar-search-main" aria-label="Close">
                            <span aria-hidden="true">Ã—</span>
                        </button>
                    </form>
                    <ul class="navbar-nav align-items-center  ml-md-auto ">
                        <li class="nav-item dropdown">
                            <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <div class="media align-items-center">
                                    <span class="avatar avatar-sm rounded-circle">
                                        <img alt="Image placeholder" id="userIcon" hidden>
                                    </span>
                                    <div class="media-body  ml-2  d-none d-lg-block">
                                        <span class="mb-0 text-sm  font-weight-bold" id="userName"></span>
                                    </div>
                                </div>
                            </a>
                            <div class="dropdown-menu  dropdown-menu-right ">
                                <div class="dropdown-header noti-title">
                                    <h6 class="text-overflow m-0">Welcome!</h6>
                                </div>
                                <button onclick="logout()" class="dropdown-item">
                                    <i class="ni ni-user-run"></i>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="header text-center" style="min-height: 200px; background-size: cover; background-position: center top;">
            <!-- <span class="mask bg-default"></span> -->
            <img width="250px" style="z-index: 10;position: sticky;" class="rounded-circle shadow" id="patientIcon">
        </div>
        <div class="container-fluid mt--3">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-12">
                                    <div class="nav-wrapper">
                                        <ul class="nav nav-pills nav-fill flex-column flex-md-row" id="tabs-icons-text" role="tablist">
                                            <li class="nav-item">
                                                <a class="nav-link mb-sm-3 mb-md-0 active" id="tabs-icons-text-1-tab" data-toggle="tab" href="#tabs-icons-text-1" role="tab" aria-controls="tabs-icons-text-1" aria-selected="true"><i class="fas fa-id-card"></i> Profile</a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link mb-sm-3 mb-md-0" id="tabs-icons-text-2-tab" data-toggle="tab" href="#tabs-icons-text-2" role="tab" aria-controls="tabs-icons-text-2" aria-selected="false"><i class="fas fa-pills"></i> Prescriptions</a>
                                            </li>
                                            <li class="nav-item" hidden id="addPrescription">
                                                <a class="nav-link mb-sm-3 mb-md-0" id="tabs-icons-text-3-tab" data-toggle="tab" href="#tabs-icons-text-3" role="tab" aria-controls="tabs-icons-text-3" aria-selected="false"><i class="fas fa-folder-plus"></i> Add Prescription</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="tab-content" id="myTabContent">
                                        <div class="tab-pane fade show active" id="tabs-icons-text-1" role="tabpanel">
                                            <form>
                                                <h6 class="heading-small text-muted mb-4">User information</h6>
                                                <div class="pl-lg-4">
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-first-name">First name</label>
                                                                <input type="text" id="input-first-name" class="form-control" placeholder="First name" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-last-name">Last name</label>
                                                                <input type="text" id="input-last-name" class="form-control" placeholder="Last name" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-username">Phone Number</label>
                                                                <input type="text" id="input-phone" class="form-control" placeholder="Number" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-email">Email address</label>
                                                                <input type="email" id="input-email" class="form-control" placeholder="jesse@example.com" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-medicare">Medicare Card Number</label>
                                                                <input id="input-medicare" class="form-control" placeholder="Medical Number" type="text" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-dateofbirth">Date of Birth <small>MM-DD-YYYY</small></label>
                                                                <input id="input-dateofbirth" class="form-control" placeholder="Date of Birth" type="text" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-sex">Sex</label>
                                                                <input id="input-sex" class="form-control" placeholder="Sex" type="text" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="my-4" />
                                                <h6 class="heading-small text-muted mb-4">Home information</h6>
                                                <div class="pl-lg-4">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-address">Address</label>
                                                                <input id="input-address" class="form-control" placeholder="Home Address" type="text" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-lg-4">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-city">City</label>
                                                                <input type="text" id="input-city" class="form-control" placeholder="City" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-country">Country</label>
                                                                <input type="text" id="input-country" class="form-control" placeholder="Country" readonly>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="form-group">
                                                                <label class="form-control-label" for="input-country">Postal code</label>
                                                                <input type="text" id="input-postal-code" class="form-control" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="my-4" />
                                                <h6 class="heading-small text-muted mb-4">Notes</h6>
                                                <div id="notes_list">

                                                </div>
                                                <div id="newNotesForm" hidden>
                                                    <div class="pl-lg-4">
                                                        <div class="form-group">
                                                            <label class="form-control-label">Additional Notes</label>
                                                            <textarea rows="4" class="form-control" placeholder="A few words about your patient..." id="input-note"></textarea>
                                                        </div>
                                                    </div>
                                                    <p class="float-right">
                                                        <button type="button" onclick="addNote()" class="btn btn-sm btn-primary"> Save Note</button>
                                                    </p>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="tab-pane fade" id="tabs-icons-text-2" role="tabpanel">
                                            <div class="row" id="prescription_list">
                                            </div>

                                        </div>
                                        <div class="tab-pane fade" id="tabs-icons-text-3" role="tabpanel">
                                            <form role="form" id="submitPrescript">
                                                <h6 class="heading-small text-muted mb-4">Prescription</h6>
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="input-first-name">Medication</label>
                                                            <input type="text" id="medication" class="form-control" placeholder="Medication" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="input-last-name">Expiration</label>
                                                            <input class="form-control" type="date" id="expiration" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12">
                                                        <div class="form-group">
                                                            <label class="form-control-label">Prescription Details</label>
                                                            <textarea rows="12" id="prescription_details" class="form-control" placeholder="Prescription Information" required></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <h6 class="heading-small text-muted mb-4">Prescription Directions<button type="button" class="btn btn-sm btn-primary float-right" id="addDirection"><i class="fas fa-plus-circle"></i> Direction</button>
                                                </h6>
                                                <div class="row">
                                                    <div class="container1 w-100">
                                                        <div class="col-12 ml-2">
                                                            <div class="form-group">
                                                                <div class="input-group">
                                                                    <div class="input-group-prepend">
                                                                        <span class="input-group-text" id="basic-addon1">1</span>
                                                                    </div>
                                                                    <input type="text" name="mytext[]" class="form-control" placeholder="Direction" required>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <hr class="my-4" />
                                                </div>
                                                <button type="submit" class="btn btn-primary my-4 btn-block">Submit</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="alert alert-success alert-dismissible fade show success" role="alert" hidden>
            <span class="alert-icon"><i class="ni ni-like-2"></i></span>
            <span class="alert-text"><strong>Success!</strong> <span id="successMSG"></span></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <script src="../assets/vendor/jquery/dist/jquery.min.js"></script>
        <script src="../assets/custom/js/auth.js"></script>
        <script src="../assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/vendor/js-cookie/js.cookie.js"></script>
        <script src="../assets/vendor/jquery.scrollbar/jquery.scrollbar.min.js"></script>
        <script src="../assets/vendor/jquery-scroll-lock/dist/jquery-scrollLock.min.js"></script>
        <script src="../assets/js/argon.js?v=1.2.0"></script>
</body>
<script>
    updateStatus();

    function updateStatus() {
        if(localStorage.getItem("userType") == 'doctor'){
            $("#addPrescription").attr("hidden", false);
            $("#newNotesForm").attr("hidden", false);
        }
        var urlParams = new URLSearchParams(window.location.search);
        var id = urlParams.get('id');
        if (!id) window.location.href = "./dashboard.html";
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                var db = firebase.firestore();
                var users = db.collection("sessions").where("doctor_id", "==", user.uid).where("status", "==", "waiting").where("uid", "==", id).limit(1)
                    .onSnapshot(function(querySnapshot) {
                        if (!querySnapshot.empty) {
                            const thing = querySnapshot.docs[0];
                            const newVal = "viewing";
                            thing.ref.update({ "status": newVal });
                        } else {
                            var checkAuth = db.collection("sessions").where("doctor_id", "==", user.uid).where("status", "==", "viewing").where("uid", "==", id).limit(1)
                                .onSnapshot(function(querySnapshot) {
                                    if (querySnapshot.empty) {
                                        window.location.href = "./dashboard.html";
                                    }else{
                                        getData();
                                    }
                                });
                        }
                    });
            } else {
                window.location.href = "./login.html";
            }
        });
    }

    function addNote() {
        var urlParams = new URLSearchParams(window.location.search);
        var id = urlParams.get('id');
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                var db = firebase.firestore();
                const dateFb = firebase.firestore.FieldValue.serverTimestamp();
                var users = db.collection("users").doc(id).update({
                    notes: firebase.firestore.FieldValue.arrayUnion({
                        author: user.uid,
                        date: new Date(),
                        note: $("#input-note").val()
                    })
                }).then(() => {
                    $("#input-note").val('');
                    displaySuccess("Note Added!");
                });
            } else {
                window.location.href = "./login.html";
            }
        });
    }

    function displaySuccess(msg) {
        $("#successMSG").text(msg);

        $(".success").attr("hidden", false).fadeIn();

        setTimeout(function() { $(".success").fadeOut(); }, 3000);

    }

    function getData() {
        var urlParams = new URLSearchParams(window.location.search);
        var id = urlParams.get('id');
        let mySet = new Set()
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                var db = firebase.firestore();
                var users = db.collection("users").doc(id).onSnapshot(function(doc) {
                    if (doc.exists) {
                        $("#input-first-name").val(doc.data().first_name);
                        $("#input-last-name").val(doc.data().last_name);
                        $("#input-phone").val(doc.data().phone);
                        $("#input-email").val(doc.data().email);
                        $("#input-medicare").val(doc.data().medical_card)
                        $("#input-dateofbirth").val(doc.data().dob);
                        $("#input-sex").val(doc.data().sex);
                        $("#patientIcon").attr("src", doc.data().icon)
                        $("#input-address").val(doc.data().home.address);
                        $("#input-postal-code").val(doc.data().home.postal_code);
                        $("#input-city").val(doc.data().home.city);
                        $("#input-country").val(doc.data().home.country);
                        $("#notes_list").empty();
                        doc.data().notes.forEach(element => {
                            mySet.add(element.author);
                            $("#notes_list").append(`
                            <div class="col-12">
                                <div class="card card-stats">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col">
                                                <h5 class="card-title text-uppercase text-muted mb-0">` + element.note + `</h5>
                                            </div>
                                            <div class="col-auto">
                                                <img class="icon icon-shape rounded-circle shadow p-0" name="img` + element.author + `">
                                                <br />
                                                <small class="text-small" name="name` + element.author + `"></small>
                                            </div>
                                        </div>
                                        <p class=" mb-0 text-sm">
                                            <span class="mr-2">` + element.date.toDate().toDateString().split(' ').slice(1).join(' ') + `</span>
                                        </p>
                                    </div>
                                </div>
                            </div>`)
                        });
                    } else {
                        console.log("No such document!");
                    }
                });


                var prescriptions = db.collection("prescription").where("uid", "==", id).orderBy("date_added", "desc")
                    .onSnapshot(function(querySnapshot) {
                        if (!querySnapshot.empty) {
                            $("#prescription_list").empty();
                            querySnapshot.forEach(function(doc) {
                                mySet.add(doc.data().doctor_id);
                                var directions = '';
                                doc.data().directions.forEach(element => {
                                    directions += '<br /><span class="mr-2"><i class="fas fa-angle-right"></i> ' + element + '</span>'
                                });
                                var deleteIcon = '';
                                if(localStorage.getItem("userType") == 'doctor')
                                    deleteIcon = `<div class="col-auto"><i class="fas fa-trash text-danger delete" onclick="deletePrescription('` + doc.id + `')"></i></div>`;
                                
                                $("#prescription_list").append(
                                    `<div class="col-4">
                                        <div class="card card-stats">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col">
                                                        <h5 class="card-title text-uppercase text-muted mb-0">` + doc.data().num_refills + ` Refills</h5>
                                                        <span class="h2 font-weight-bold mb-0">` + doc.data().medication + `</span>
                                                    </div>
                                                    <div class="col-auto">
                                                        <img class="icon icon-shape rounded-circle shadow p-0" name="img` + doc.data().doctor_id + `">
                                                        <br />
                                                        <small class="text-small" name="name` + doc.data().doctor_id + `"></small>
                                                    </div>
                                                </div>
                                                <p class="mt-3 mb-0 text-sm">
                                                    <span class="text-uppercase mr-2 text-primary">Directions</span>
                                                    ` + directions + `
                                                </p>
                                                <div class="row">
                                                    <div class="col">
                                                        <p class="mt-3 mb-0 text-sm">
                                                            <span class="mr-2">Prescribed: <span class="text-success">` + doc.data().date_added.toDate().toDateString().split(' ').slice(1).join(' ') + `</span></span>
                                                            <br />
                                                            <span>Expiration: <span class="text-danger">` + doc.data().expiry_date.toDate().toDateString().split(' ').slice(1).join(' ') + `</span></span>
                                                        </p>
                                                    </div>
                                                    `+deleteIcon+`
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div>`
                                )
                            });


                            for (let item of mySet) {
                                var docRef = db.collection("users").doc(item);

                                docRef.get().then(function(doc) {
                                    if (doc.exists) {
                                        $('img[name=img' + item + ']').attr('src', doc.data().icon);
                                        $('small[name=name' + item + ']').text(doc.data().first_name + " " + doc.data().last_name)
                                    } else {
                                        console.log("No such document!");
                                    }
                                }).catch(function(error) {
                                    console.log("Error getting document:", error);
                                });
                            }
                        }

                    });
            } else {
                window.location.href = "./login.html";
            }
        });
    }

    $(document).ready(function() {
        var max_fields = 10;
        var wrapper = $(".container1");
        var add_button = $("#addDirection");

        var x = 1;
        $(add_button).click(function(e) {
            e.preventDefault();
            if (x < max_fields) {
                x++;
                $(wrapper).append(`
                <div class="col-12 ml-2">
                    <div class="form-group">
                        <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1">` + x + `</span>
                                </div>
                                <input type="text" name="mytext[]" class="form-control" placeholder="Direction">
                        </div>
                    </div>
                </div>
                `); //add input box
            } else {
                alert('You Reached the limits')
            }
        });

        $(wrapper).on("click", ".delete", function(e) {
            e.preventDefault();
            $(this).parent('div').remove();
            x--;
        })
    });

    $("#submitPrescript").submit(function(event) {
        event.preventDefault();
        if ($("#submitPrescript")[0].checkValidity()) {
            var urlParams = new URLSearchParams(window.location.search);
            var id = urlParams.get('id');
            var directions = [];
            jQuery("input[name='mytext[]']").each(function() {
                if (this.value != null && this.value != "")
                    directions.push(this.value);
            });
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    firebase.firestore().collection('prescription').add({
                        doctor_id: user.uid,
                        prescription_details: $("#prescription_details").val(),
                        num_refills: '0',
                        medication: $("#medication").val(),
                        expiry_date: new Date($("#expiration").val()),
                        directions: directions,
                        date_added: firebase.firestore.FieldValue.serverTimestamp(),
                        uid: id
                    }).then(() => {
                        $('#submitPrescript').trigger("reset");
                        displaySuccess("Prescription Added!");
                        $(".container1").html(`
                        <div class="col-12 ml-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="basic-addon1">1</span>
                                    </div>
                                    <input type="text" name="mytext[]" class="form-control" placeholder="Direction" required>
                                </div>
                            </div>
                        </div>
                        `)
                    });
                } else {
                    window.location.href = "./login.html";
                }
            });
        }
    });

    function deletePrescription(id) {
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                firebase.firestore().collection("prescription").doc(id).delete().then(function() {
                    displaySuccess("Prescription Deleted!");
                }).catch(function(error) {
                    console.error("Error removing document: ", error);
                });
            } else {
                window.location.href = "./login.html";
            }
        });
    }
</script>

</html>